<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>Xaman xAppToken Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      color: #333;
    }
    .container {
      text-align: center;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      max-width: 600px;
    }
    .error { color: #d32f2f; font-weight: bold; }
    .success { color: #388e3c; font-weight: bold; }
    .info { color: #0288d1; font-style: italic; }
    input { margin: 10px; padding: 5px; width: 80%; }
    button { padding: 5px 10px; }
    pre { text-align: left; background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 300px; overflow: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Xaman xAppToken Test</h1>
    <p id="status">Initializing...</p>
    <pre id="env-info">Environment: Checking...</pre>
    <div>
      <input id="manualToken" type="text" placeholder="Enter xAppToken (e.g., test123)" value="test123">
      <button onclick="testManualToken()">Test Manual xAppToken</button>
    </div>
  </div>

  <script src="https://xumm.app/assets/cdn/xumm.min.js"></script>
  <script>
    // Log every step
    console.log('1. Script started at:', new Date().toISOString());
    console.log('2. URL:', window.location.href);
    console.log('3. Query parameters:', window.location.search);
    console.log('4. Browser:', {
      userAgent: navigator.userAgent,
      online: navigator.onLine
    });
    console.log('5. Xaman SDK script loaded:', typeof Xumm !== 'undefined');

    // Update status
    function updateStatus(message, isError = false, isInfo = false) {
      console.log('6. Updating status:', message);
      const statusElement = document.getElementById('status');
      statusElement.textContent = message;
      statusElement.className = isError ? 'error' : isInfo ? 'info' : 'success';
    }

    // Update environment info
    function updateEnvInfo(token, tokenDetails, ottData, sdkMethods) {
      console.log('7. Updating environment info...');
      const envInfo = {
        URL: window.location.href,
        Query: window.location.search || 'None',
        Online: navigator.onLine ? 'Yes' : 'No',
        UserAgent: navigator.userAgent,
        SDKAvailable: typeof Xumm !== 'undefined' ? 'Yes' : 'No',
        xAppToken: token ? token.substring(0, 10) + '...' : 'Not found',
        TokenDetails: tokenDetails || 'None',
        OTTData: ottData || 'None',
        SDKMethods: sdkMethods || 'None'
      };
      document.getElementById('env-info').textContent = `Environment:\n${JSON.stringify(envInfo, null, 2)}`;
    }

    // Decode JWT payload
    function decodeJwtPayload(token) {
      console.log('8. Decoding JWT payload...');
      try {
        if (!token || token.split('.').length !== 3) {
          console.log('9. Invalid JWT format:', token);
          return { error: 'Invalid JWT format' };
        }
        const payload = token.split('.')[1];
        const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
        console.log('10. JWT payload decoded:', decoded);
        return JSON.parse(decoded);
      } catch (error) {
        console.log('11. JWT decode failed:', {
          message: error.message,
          stack: error.stack
        });
        return { error: 'Failed to decode JWT: ' + error.message };
      }
    }

    // Check for xAppToken
    console.log('12. Checking URL for xAppToken...');
    let token = null;
    const url = new URL(window.location.href);
    token = url.searchParams.get('xAppToken');
    console.log('13. xAppToken:', token ? token.substring(0, 10) + '...' : 'Not found');
    const tokenDetails = decodeJwtPayload(token);

    // Initialize environment display
    updateStatus('Script running. Checking xAppToken...');
    updateEnvInfo(token, tokenDetails, 'Not yet checked', 'Not yet initialized');

    // Initialize Xaman SDK
    console.log('14. Initializing Xaman SDK...');
    const apiKey = 'ed16b1ec-0a7a-4458-9c9c-eecfd9972955';
    let xumm = null;
    try {
      console.log('15. Creating Xumm instance...');
      xumm = new Xumm(apiKey);
      console.log('16. SDK initialized with API key:', apiKey);
      console.log('17. SDK user methods:', Object.keys(xumm.user || {}));
      console.log('18. SDK environment methods:', Object.keys(xumm.environment || {}));
    } catch (error) {
      console.log('19. SDK initialization failed:', {
        message: error.message,
        stack: error.stack
      });
      updateStatus('Error: SDK initialization failed. Check API key.', true);
      updateEnvInfo(token, tokenDetails, 'SDK failed', 'SDK failed to initialize');
    }

    // Check OTT for JWT
    let ottData = 'Not fetched';
    if (xumm) {
      console.log('20. Fetching OTT data...');
      try {
        xumm.environment.ott().then(ott => {
          console.log('21. OTT data:', ott);
          ottData = ott || 'No OTT data';
          updateEnvInfo(token, tokenDetails, ottData, Object.keys(xumm.user || {}));
        }).catch(error => {
          console.log('22. OTT fetch failed:', {
            message: error.message,
            stack: error.stack
          });
          ottData = 'Failed: ' + error.message;
          updateEnvInfo(token, tokenDetails, ottData, Object.keys(xumm.user || {}));
        });
      } catch (error) {
        console.log('23. OTT call failed:', {
          message: error.message,
          stack: error.stack
        });
        ottData = 'Failed: ' + error.message;
        updateEnvInfo(token, tokenDetails, ottData, Object.keys(xumm.user || {}));
      }
    }

    // Manual xAppToken test
    function testManualToken() {
      console.log('24. Manual xAppToken test started at:', new Date().toISOString());
      const manualToken = document.getElementById('manualToken').value;
      console.log('25. Manual xAppToken:', manualToken ? manualToken.substring(0, 10) + '...' : 'Empty');
      if (!manualToken) {
        console.log('26. Manual xAppToken test failed: Input empty');
        updateStatus('Error: Enter an xAppToken in the input field.', true);
        return;
      }
      const manualTokenDetails = decodeJwtPayload(manualToken);
      updateEnvInfo(manualToken, manualTokenDetails, ottData, xumm ? Object.keys(xumm.user || {}) : 'SDK not initialized');
      authenticateXaman(manualToken);
    }

    // Authentication function
    function authenticateXaman(manualToken) {
      console.log('27. Authentication started at:', new Date().toISOString());
      console.log('28. Using xAppToken:', manualToken ? manualToken.substring(0, 10) + '...' : token ? token.substring(0, 10) + '...' : 'None');
      
      const authToken = manualToken || token;
      const authTokenDetails = manualToken ? decodeJwtPayload(manualToken) : tokenDetails;
      if (!authToken) {
        console.log('29. No xAppToken available');
        updateStatus('No xAppToken found. Launch from Xaman wallet/IDE or use manual input.', true);
        updateEnvInfo(authToken, authTokenDetails, ottData, xumm ? Object.keys(xumm.user || {}) : 'SDK not initialized');
        return;
      }

      if (!xumm) {
        console.log('30. SDK not initialized');
        updateStatus('Error: SDK not initialized.', true);
        updateEnvInfo(authToken, authTokenDetails, ottData, 'SDK not initialized');
        return;
      }

      console.log('31. Setting xAppToken in SDK...');
      xumm.environment.jwt = authToken;

      console.log('32. Fetching user data...');
      try {
        // Try xumm.user.account as a method or property
        const accountPromise = typeof xumm.user.account === 'function' ? xumm.user.account() : Promise.resolve(xumm.user.account);
        accountPromise.then(userData => {
          console.log('33. User data:', userData);
          if (!userData || (!userData.account && typeof userData !== 'string')) {
            console.log('34. Invalid user data:', userData);
            updateStatus('Error: No r-address found.', true);
            updateEnvInfo(authToken, authTokenDetails, ottData, Object.keys(xumm.user || {}));
            return;
          }
          const rAddress = typeof userData === 'string' ? userData : userData.account;
          console.log('35. r-address:', rAddress);
          updateStatus(`Authenticated! Your r-address: ${rAddress}`);
          updateEnvInfo(authToken, authTokenDetails, ottData, Object.keys(xumm.user || {}));
        }).catch(error => {
          console.log('36. User data fetch failed:', {
            message: error.message,
            stack: error.stack
          });
          updateStatus(`Error: Failed to fetch user data (${error.message})`, true);
          updateEnvInfo(authToken, authTokenDetails, ottData, Object.keys(xumm.user || {}));
        });
      } catch (error) {
        console.log('37. SDK account call failed:', {
          message: error.message,
          stack: error.stack
        });
        updateStatus(`Error: SDK account call failed (${error.message})`, true);
        updateEnvInfo(authToken, authTokenDetails, ottData, Object.keys(xumm.user || {}));
      }
    }

    // Start authentication
    console.log('38. Starting initial authentication...');
    authenticateXaman();
  </script>
</body>
</html>